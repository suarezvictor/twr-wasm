
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="twr-wasm allows you to implement new C/C++ APIs in JavaScript/TypeScript by extending the twrLibrary class.">
      
      
      
        <link rel="canonical" href="https://twiddlingbits.dev/docsite/api/api-ts-library/">
      
      
        <link rel="prev" href="../api-ts-memory/">
      
      
        <link rel="next" href="../../more/wasm-problem/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.28">
    
    
      
        <title>Use twrLibrary to Implement Wasm C/C++ API in TypeScript - Easier WebAssembly with twr-wasm</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.6543a935.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#twr-wasm-libraries" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Easier WebAssembly with twr-wasm" class="md-header__button md-logo" aria-label="Easier WebAssembly with twr-wasm" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Easier WebAssembly with twr-wasm
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Use twrLibrary to Implement Wasm C/C++ API in TypeScript
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/twiddlingbits/twr-wasm" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../gettingstarted/installation/" class="md-tabs__link">
          
  
  Getting Started

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../examples/examples-overview/" class="md-tabs__link">
          
  
  Examples

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../api-c-general/" class="md-tabs__link">
          
  
  C/C++ API

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../api-ts-modules/" class="md-tabs__link">
          
  
  TypeScript API

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../more/wasm-problem/" class="md-tabs__link">
          
  
  More

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Easier WebAssembly with twr-wasm" class="md-nav__button md-logo" aria-label="Easier WebAssembly with twr-wasm" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Easier WebAssembly with twr-wasm
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/twiddlingbits/twr-wasm" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Getting Started
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Getting Started
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gettingstarted/installation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gettingstarted/helloworld/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Hello World
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gettingstarted/basicsteps/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Basic Steps
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gettingstarted/parameters/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Passing Arguments
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gettingstarted/stdio/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Consoles
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gettingstarted/events/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Events
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gettingstarted/charencoding/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Character Encoding
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gettingstarted/debugging/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Debugging
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gettingstarted/compiler-opts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Compiler, Linker, Memory
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Examples
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Examples
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/examples-overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/examples-helloworld/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    hello world
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/examples-divcon/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    divcon
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/examples-terminal/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    terminal
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/examples-multi-io/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    multi-io
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/examples-fft/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    fft
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/examples-balls/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    balls
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/examples-pong/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pong
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/examples-maze/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    maze
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/examples-callc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    callC
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/examples-lib/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    library
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/examples-libcxx/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    libc++
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    C/C++ API
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            C/C++ API
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api-c-general/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    General
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api-c-localization/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Localization
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api-c-d2d/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Draw 2D
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api-c-con/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Console Char I/O
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api-c-stdlib/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Standard C Library
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api-libcpp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    libc++
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api-c-audio/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Audio
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    TypeScript API
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            TypeScript API
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api-ts-modules/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Modules
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api-ts-consoles/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Consoles
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api-ts-memory/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Memory
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Libraries
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Libraries
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#basic-steps" class="md-nav__link">
    <span class="md-ellipsis">
      Basic Steps
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lib-example" class="md-nav__link">
    <span class="md-ellipsis">
      Lib Example
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example-twrlibtimer" class="md-nav__link">
    <span class="md-ellipsis">
      Example twrLibTimer
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#c-header-files" class="md-nav__link">
    <span class="md-ellipsis">
      C Header Files
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#registering-your-api" class="md-nav__link">
    <span class="md-ellipsis">
      Registering your API
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example-function-explained" class="md-nav__link">
    <span class="md-ellipsis">
      Example Function Explained
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#events" class="md-nav__link">
    <span class="md-ellipsis">
      Events
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#imports" class="md-nav__link">
    <span class="md-ellipsis">
      imports
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#callingmod" class="md-nav__link">
    <span class="md-ellipsis">
      callingMod
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#numbers-only" class="md-nav__link">
    <span class="md-ellipsis">
      Numbers Only
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#memwasm" class="md-nav__link">
    <span class="md-ellipsis">
      memWasm
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#twrwasmmodule-and-twrwasmmoduleasync" class="md-nav__link">
    <span class="md-ellipsis">
      twrWasmModule and twrWasmModuleAsync.
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#twrwasmmoduleasync-thread-structure" class="md-nav__link">
    <span class="md-ellipsis">
      twrWasmModuleAsync thread structure
    </span>
  </a>
  
    <nav class="md-nav" aria-label="twrWasmModuleAsync thread structure">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-twr_sleep-function-is-used-to-illustrate-thread-structure" class="md-nav__link">
    <span class="md-ellipsis">
      The twr_sleep function is used to illustrate thread structure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#twrwasmmoduleasync-uses-two-threads" class="md-nav__link">
    <span class="md-ellipsis">
      twrWasmModuleAsync uses Two Threads
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#blocking-function-explained" class="md-nav__link">
    <span class="md-ellipsis">
      Blocking Function Explained
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#import-options" class="md-nav__link">
    <span class="md-ellipsis">
      import options
    </span>
  </a>
  
    <nav class="md-nav" aria-label="import options">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#isasyncfunction" class="md-nav__link">
    <span class="md-ellipsis">
      isAsyncFunction
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ismoduleasynconly" class="md-nav__link">
    <span class="md-ellipsis">
      isModuleAsyncOnly
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#iscommoncode" class="md-nav__link">
    <span class="md-ellipsis">
      isCommonCode
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#noblock" class="md-nav__link">
    <span class="md-ellipsis">
      noBlock
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#libsourcepath" class="md-nav__link">
    <span class="md-ellipsis">
      libSourcePath
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#interfacename" class="md-nav__link">
    <span class="md-ellipsis">
      interfaceName
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-twrwasmmoduleasync-event-loop" class="md-nav__link">
    <span class="md-ellipsis">
      The twrWasmModuleAsync Event Loop
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    More
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            More
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../more/wasm-problem/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Wasm Runtime Limitations
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../more/imports/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Import Resolution
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../more/production/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SharedArrayBuffers Note
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../more/building/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Building the Source
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#basic-steps" class="md-nav__link">
    <span class="md-ellipsis">
      Basic Steps
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lib-example" class="md-nav__link">
    <span class="md-ellipsis">
      Lib Example
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example-twrlibtimer" class="md-nav__link">
    <span class="md-ellipsis">
      Example twrLibTimer
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#c-header-files" class="md-nav__link">
    <span class="md-ellipsis">
      C Header Files
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#registering-your-api" class="md-nav__link">
    <span class="md-ellipsis">
      Registering your API
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example-function-explained" class="md-nav__link">
    <span class="md-ellipsis">
      Example Function Explained
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#events" class="md-nav__link">
    <span class="md-ellipsis">
      Events
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#imports" class="md-nav__link">
    <span class="md-ellipsis">
      imports
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#callingmod" class="md-nav__link">
    <span class="md-ellipsis">
      callingMod
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#numbers-only" class="md-nav__link">
    <span class="md-ellipsis">
      Numbers Only
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#memwasm" class="md-nav__link">
    <span class="md-ellipsis">
      memWasm
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#twrwasmmodule-and-twrwasmmoduleasync" class="md-nav__link">
    <span class="md-ellipsis">
      twrWasmModule and twrWasmModuleAsync.
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#twrwasmmoduleasync-thread-structure" class="md-nav__link">
    <span class="md-ellipsis">
      twrWasmModuleAsync thread structure
    </span>
  </a>
  
    <nav class="md-nav" aria-label="twrWasmModuleAsync thread structure">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-twr_sleep-function-is-used-to-illustrate-thread-structure" class="md-nav__link">
    <span class="md-ellipsis">
      The twr_sleep function is used to illustrate thread structure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#twrwasmmoduleasync-uses-two-threads" class="md-nav__link">
    <span class="md-ellipsis">
      twrWasmModuleAsync uses Two Threads
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#blocking-function-explained" class="md-nav__link">
    <span class="md-ellipsis">
      Blocking Function Explained
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#import-options" class="md-nav__link">
    <span class="md-ellipsis">
      import options
    </span>
  </a>
  
    <nav class="md-nav" aria-label="import options">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#isasyncfunction" class="md-nav__link">
    <span class="md-ellipsis">
      isAsyncFunction
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ismoduleasynconly" class="md-nav__link">
    <span class="md-ellipsis">
      isModuleAsyncOnly
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#iscommoncode" class="md-nav__link">
    <span class="md-ellipsis">
      isCommonCode
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#noblock" class="md-nav__link">
    <span class="md-ellipsis">
      noBlock
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#libsourcepath" class="md-nav__link">
    <span class="md-ellipsis">
      libSourcePath
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#interfacename" class="md-nav__link">
    <span class="md-ellipsis">
      interfaceName
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-twrwasmmoduleasync-event-loop" class="md-nav__link">
    <span class="md-ellipsis">
      The twrWasmModuleAsync Event Loop
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="twr-wasm-libraries">twr-wasm Libraries</h1>
<p>twr-wasm Libraries are used to expose TypeScript code to C/C++ as C APIs.  All of the twr-wasm C APIs are implemented with twr-wasm libraries.  You can also use a library to implement your own C APIs using TypeScript.</p>
<p>There are two kinds of Libraries:</p>
<ul>
<li>Those that have only once instance (such as the math library)</li>
<li>Those that can have multiple instances across one or more library types, where each library type implements the same interface.  Consoles are an example of this (see <a href="#interfacename">interfaceName</a>).</li>
</ul>
<h2 id="basic-steps">Basic Steps</h2>
<p>twr-wasm Libraries support both <code>twrWasmModule</code> and <code>twrWasmModuleAsync</code>.  That is, when you create a twrLibrary, it will function with either type of module.  In many cases no extra work is needed for the <code>twrWasmModuleAsync</code>, but in some cases, extra code is needed.</p>
<p>The class <code>twrLibrary</code>  provides the core functionality:</p>
<ul>
<li>Support for functions to be imported into the WebAssembly Module</li>
<li>Support for <code>twrWasmModuleAsync</code> proxy Web Worker thread</li>
<li>An event framework, allowing you to post events to WebAssembly C code.</li>
</ul>
<p>To implement a twr-wasm library you:</p>
<ul>
<li>create a new TypeScript class that extends <code>class twrLibrary</code>.  </li>
<li>create a C .h file for your new functions (with function signatures)</li>
<li>add one or more functions to your TypeScript class</li>
<li>add the functions to the <code>import</code> object (that is part of your class)</li>
<li>consider if special handling is needed for <code>twrWasmModuleAsync</code> (more on this below)</li>
</ul>
<h2 id="lib-example">Lib Example</h2>
<p>See the <code>lib</code> <a href="../../examples/examples-lib/">example here</a> for a more complete example which shows how each of the different use cases can be handled.  In addition, you can look in <code>/source/twr-ts</code> for files that start with <code>twrlib*</code> or <code>twrcon*</code> for examples.</p>
<h2 id="example-twrlibtimer">Example twrLibTimer</h2>
<p>The following code is from the twr-wasm source for twrlibtimer.</p>
<ul>
<li><code>twr_timer_single_shot</code> - sends an event to C after the timer times out.</li>
<li><code>twr_sleep</code> - blocks C execution for a period of time.</li>
</ul>
<div class="language-js highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="nx">IWasmModule</span><span class="p">,}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;./twrmod.js&quot;</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="nx">IWasmModuleAsync</span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;./twrmodasync.js&quot;</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="nx">twrLibrary</span><span class="p">,</span><span class="w"> </span><span class="nx">TLibImports</span><span class="p">,</span><span class="w"> </span><span class="nx">twrLibraryInstanceRegistry</span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;./twrlibrary.js&quot;</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="c1">// Libraries use default export</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">twrLibTimer</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">twrLibrary</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="w">   </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="nx">number</span><span class="p">;</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="w">   </span><span class="nx">imports</span><span class="o">:</span><span class="nx">TLibImports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="w">      </span><span class="nx">twr_timer_single_shot</span><span class="o">:</span><span class="p">{},</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="w">      </span><span class="nx">twr_sleep</span><span class="o">:</span><span class="p">{</span><span class="nx">isAsyncFunction</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">isModuleAsyncOnly</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">},</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="w">   </span><span class="p">};</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="w">   </span><span class="nx">libSourcePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="k">import</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">url</span><span class="p">).</span><span class="nx">pathname</span><span class="p">;</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="w">   </span><span class="kr">constructor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="w">      </span><span class="c1">// all library constructors should start with these two lines</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="w">      </span><span class="k">super</span><span class="p">();</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="o">=</span><span class="nx">twrLibraryInstanceRegistry</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="w">   </span><span class="p">}</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="w">   </span><span class="nx">twr_timer_single_shot</span><span class="p">(</span><span class="nx">callingMod</span><span class="o">:</span><span class="nx">IWasmModule</span><span class="o">|</span><span class="nx">IWasmModuleAsync</span><span class="p">,</span><span class="w"> </span><span class="nx">milliSeconds</span><span class="o">:</span><span class="nx">number</span><span class="p">,</span><span class="w">  </span><span class="nx">eventID</span><span class="o">:</span><span class="nx">number</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="w">      </span><span class="nx">setTimeout</span><span class="p">(()=&gt;{</span>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="w">         </span><span class="nx">callingMod</span><span class="p">.</span><span class="nx">postEvent</span><span class="p">(</span><span class="nx">eventID</span><span class="p">)</span>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a><span class="w">      </span><span class="p">},</span><span class="w"> </span><span class="nx">milliSeconds</span><span class="p">);</span><span class="w">     </span>
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a><span class="w">   </span><span class="p">}</span>
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a><span class="w">   </span><span class="k">async</span><span class="w"> </span><span class="nx">twr_sleep_async</span><span class="p">(</span><span class="nx">callingMod</span><span class="o">:</span><span class="nx">IWasmModuleAsync</span><span class="p">,</span><span class="w"> </span><span class="nx">milliSeconds</span><span class="o">:</span><span class="nx">number</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a><span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="nx">resolve</span><span class="p">)=&gt;{</span>
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a><span class="w">         </span><span class="nx">setTimeout</span><span class="p">(()=&gt;{</span><span class="w"> </span><span class="nx">resolve</span><span class="p">()</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">milliSeconds</span><span class="p">);</span><span class="w">  </span>
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a><span class="w">      </span><span class="p">});</span>
</span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">p</span><span class="p">;</span>
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a><span class="w">   </span><span class="p">}</span>
</span><span id="__span-0-34"><a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>
</span><span id="__span-0-35"><a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a><span class="p">}</span>
</span></code></pre></div>
<h2 id="c-header-files">C Header Files</h2>
<p>You need to create a .h file that provides signatures to the C users of your new API.  For example, for this library your .h file would be this:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>__attribute__((import_name(&quot;twr_timer_single_shot&quot;))) void twr_timer_single_shot(int ms, int event_id);
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>__attribute__((import_name(&quot;twr_sleep&quot;))) void twr_sleep(int ms);
</span></code></pre></div>
<p>The purpose of <code>import_name</code> code is to export your functions from WebAssembly to JavaScript.  These are an equivalent alternative to adding the functions to an <code>wasm-ld</code> <code>-export</code> option.</p>
<h2 id="registering-your-api">Registering your API</h2>
<p>To register you class so that the APIs are available to C code, you use code akin to this in your <code>index.html</code> (or similar):
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>import twrLibTimerMod from &quot;./twrlibtimer.js&quot;  // default export
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>new twrLibTimerMod();  // will register itself
</span></code></pre></div></p>
<p>If you are a contributor to twr-wasm and plan to add your library as new built-in APIs, add the registration to <code>twrLibBultins.ts</code></p>
<h2 id="example-function-explained">Example Function Explained</h2>
<p>Here is what is happening in this code:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>imports:TLibImports = {
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>   twr_timer_single_shot:{},
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>}
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>// this function will work in both twrWasmModule and twrWasmModuleAsync
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>twr_timer_single_shot(callingMod:IWasmModule|IWasmModuleAsync, milliSeconds:number,  eventID:number) {
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>   setTimeout(()=&gt;{
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>      callingMod.postEvent(eventID)
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>   }, milliSeconds);     
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>}
</span></code></pre></div>
<p><code>twr_timer_single_shot</code> is listed in the <code>imports</code> class member variable which causes the function <code>twr_timer_single_shot</code> to be added to the WebAssembly.ModuleImports imports. </p>
<p>The argument for <code>callingMod:IWasmModule|IWasmModuleAsync</code> is filled in by the <code>twrLibrary</code> code -- the calling C function does not include this as an argument.   All Parameters following <code>callingMod</code> are passed by the C code calling the function.</p>
<p><code>twr_timer_single_shot</code> creates a JavaScript timer.  When the timer completes, an event is posted, which will trigger a callback in the C code.</p>
<h2 id="events">Events</h2>
<p>To receive an Event, the C code needs to register an event callback, and then pass the event ID to the function that will generate events.  Like this:</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="n">__attribute__</span><span class="p">((</span><span class="n">export_name</span><span class="p">(</span><span class="s">&quot;on_timer&quot;</span><span class="p">)))</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="kt">void</span><span class="w"> </span><span class="n">on_timer</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">event_id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="w">   </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;timer callback 2 entered (event id=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">event_id</span><span class="p">);</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="p">}</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="n">__attribute__</span><span class="p">((</span><span class="n">export_name</span><span class="p">(</span><span class="s">&quot;twr_main&quot;</span><span class="p">)))</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="kt">void</span><span class="w"> </span><span class="n">twr_main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">timer1</span><span class="o">=</span><span class="n">twr_register_callback</span><span class="p">(</span><span class="s">&quot;on_timer&quot;</span><span class="p">);</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="w">   </span><span class="n">twr_timer_single_shot</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="w"> </span><span class="n">timer</span><span class="p">);</span>
</span></code></pre></div>
<p>In this example, <code>on_timer</code> will be called after 2 seconds.</p>
<p><code>__attribute__((export_name("on_timer")))</code> is needed because this C function is exported out of the WebAssembly module and into the JavaScript code.  JavaScript needs to call this function.</p>
<p>In this example, the event does not have any arguments.  But it may -- integers (which includes pointers) can be accepted as arguments to the event callback.  These arguments are event specific.</p>
<h2 id="imports">imports</h2>
<p>All TypeScript functions that you wish to import into a WebAssembly module as C APIs, should be listed in the <code>imports</code> object.</p>
<p>Each function in the <code>imports</code> object has optional options, that are primarily for use with <code>twrWasmModuleAsync</code> modules.</p>
<p><code>imports</code> are added to WebAssembly.ModuleImports imports.</p>
<h2 id="callingmod">callingMod</h2>
<p>Each function listed in the <code>import</code> section will be passed a module as the first parameter.  In general, a function should be written to handle being called either with <code>IWasmModule</code> or <code>IWasmModuleAsync</code> as the calling module interface ( <code>callingMod:IWasmModule|IWasmModuleAsync</code> ).  This is generally straight forward.  </p>
<p>Examples that might cause some extra work, and that are covered below, are:</p>
<ul>
<li>Implementing  blocking functions like <code>twr_sleep</code></li>
<li>Allocating memory, for example, to return a string</li>
</ul>
<h2 id="numbers-only">Numbers Only</h2>
<p>All of the parameters received by an <code>import</code> function need to be numbers.  These functions interface directly with the WebAssembly module with no conversion.  If you are passing or returning strings, or accessing structures, you will need to use the data access functions that are provided in <code>callingMod.memWasm</code> (more on this below).  The general issue and approach is <a href="../../gettingstarted/parameters/">explained in this document.</a>.</p>
<h2 id="memwasm">memWasm</h2>
<p>A <code>callingMod</code> member function that you may need to use is <code>memWasm</code> (<code>callingMod.memWasm</code>).   <code>memWasm</code> is used to access data in the WebAssembly Memory.  This will happen when you need to dereference a pointer, access strings, or access structures. <a href="../api-ts-memory/#accessing-data-in-webassembly-memory">See <code>wasmMem</code> documentation here</a>.</p>
<p><code>memWasm</code> is exposed by both <code>IWasmModule</code> and <code>IWasmModuleAsync</code>.  </p>
<ul>
<li><code>IWasmModule</code> exposes <code>wasmMem: IWasmMemory</code> </li>
<li><code>IWasmModuleAsync</code> exposes <code>wasmMem: IWasmMemoryAsync</code>.  </li>
</ul>
<p>If you wish to write a function that accesses the <code>async</code> <code>PutXXX</code> functions, you should use the <code>isAsyncFunction: true</code> option.</p>
<h2 id="twrwasmmodule-and-twrwasmmoduleasync"><code>twrWasmModule</code> and <code>twrWasmModuleAsync</code>.</h2>
<p>twrLibrary's are designed to work with either <code>twrWasmModule</code> and <code>twrWasmModuleAsync</code>.  (Recall that twr-wasm has two different module types:  <code>twrWasmModule</code> and <code>twrWasmModuleAsync</code>).</p>
<ul>
<li><code>twrWasmModule</code> runs in the JavaScript main thread, and thus all functions that it exposes are asynchronous -- meaning that they should return relatively quickly and not block execution.</li>
<li><code>twrWasmModuleAsync</code> runs in a JavaScript Worker thread , and thus all functions that it exposes are synchronous  -- meaning they can block C execution.  The "Async" in <code>twrWasmModuleAsync</code> refers to the fact that javaScript can <code>await</code> on <code>twrWasmModuleAsync</code> blocking APIs.  It takes blocking APIs and makes them "asynchronous" to the JavaScript main thread.</li>
</ul>
<p>Although many functions can be listed in <code>imports</code> and written without worrying about which type of module is using them, this isn't always true.  Some tomes extra code or thought is needed to have optimal APIs for <code>twrWasmModuleAsync</code>.</p>
<p>In the above example, <code>twr_timer_single_shot</code> will work correctly with both <code>twrWasmModule</code> and <code>twrWasmModuleAsync</code>.  It is an asynchronous function -- meaning that it returns quickly.  </p>
<p>However, the function <code>twr_sleep</code> blocks C code, and will only work with <code>twrWasmModuleAsync</code>.</p>
<h2 id="twrwasmmoduleasync-thread-structure"><code>twrWasmModuleAsync</code> thread structure</h2>
<p>To understand more clearly why <code>twrWasmModuleAsync</code> might need more attention, it is helpful to understand how it is allocates task between its two threads: the JavaScript main thread, and a worker thread.</p>
<h3 id="the-twr_sleep-function-is-used-to-illustrate-thread-structure">The <code>twr_sleep</code> function is used to illustrate thread structure</h3>
<p>The function <code>twr_sleep_async</code> will only function with <code>twrWasmModuleAsync</code> because it causes the C code to block.  For example, <code>twr_sleep</code> can be used like this:</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="n">printf</span><span class="p">(</span><span class="s">&quot;going to sleep...&quot;</span><span class="p">);</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="n">twr_sleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="n">printf</span><span class="p">(</span><span class="s">&quot;awake!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span></code></pre></div>
<h3 id="twrwasmmoduleasync-uses-two-threads"><code>twrWasmModuleAsync</code> uses Two Threads</h3>
<p>The<code>twrWasmModuleAsync</code> consists of two threads:  The JavaScript main thread, and the Web Worker.  By default the code for your library functions is always executed in the JavaScript main thread.   In the Web Worker, an internal class called <code>twrWasmModuleAsyncProxy</code> executes.  The default execution (unless <code>isCommonCode</code> is specified -- which is explained later), happens like this:</p>
<ol>
<li>in C: twr_sleep() is called</li>
<li>in <code>twrWasmModuleAsyncProxy</code>, a message is sent to the JavaScript main thread, requesting execution of the <code>twrLibTimer.twr_sleep</code> function.</li>
<li><code>twrWasmModuleAsyncProxy</code> is paused (thus <code>twr_sleep</code> is blocking), waiting for a response to the message sent ins step 2.</li>
<li>The JavaScript main thread receives the message, and <code>awaits</code> on <code>twrLibTimer.twr_sleep</code></li>
<li>When the Promise that is being awaited on resolves, the JavaScript main threads sends a reply back to <code>twrWasmModuleAsyncProxy</code> indicating that execution is complete. If there are any return codes they are also sent (twr_sleep does not have a return code)</li>
<li><code>twr_sleep</code> returns to the C caller</li>
</ol>
<p>The above sequence actually happens for all <code>import</code> functions by default when using <code>twrWasmModuleAsync</code>, irregardless if or how long they block for.  This is because certain JavaScript code can only execute in the JavaScript main thread.  Import function options exists to modify this behavior, in the cases where it is not desired.</p>
<p>The above steps also glosses over an important point -- the method that the <code>twrWasmModuleAsyncProxy</code> uses to wait for a response from the main JavaScript thread.  In step 3 above (Worker thread is blocking from <code>twr_sleep</code> call), the worker thread is blocking on a call to <code>Atomics.wait</code>.  Communication from the JavaScript main thread to the Worker is through shared memory and a circular buffer.  This is how twrWasmModuleAsync is able to block execution of the C code.  This means that the Worker Thead main event loop can block for long periods of time -- perhaps indefinitely.  And this means common JavaScript code can not run reliably in the Worker thread.  For example, a setTimeout callback may not happen (because it is dispatched by the main JavaScript event loop).  Likewise, Animations won't work since they are often executed inside the JavaScript event loop.   This is another important reason that all the <code>import</code> code generally runs inside the JavaScript main thread.</p>
<h2 id="blocking-function-explained">Blocking Function Explained</h2>
<p>twr-wasm supports blocking functions like sleep when the API user is using <code>twrWasmModuleAsync</code>. This section explains the <code>sleep</code> function which causes C code to block.  In other words, in C, code like this will work:</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="n">printf</span><span class="p">(</span><span class="s">&quot;going to sleep...&quot;</span><span class="p">);</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="n">twr_sleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="n">printf</span><span class="p">(</span><span class="s">&quot;awake!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span></code></pre></div>
<p>The TypeScript twrLibrary derived class implementation looks like this:</p>
<div class="language-js highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1">// this function will only work in twrWasmModuleAsync since it blocks the C caller.</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="k">async</span><span class="w"> </span><span class="nx">twr_sleep_async</span><span class="p">(</span><span class="nx">callingMod</span><span class="o">:</span><span class="nx">IWasmModuleAsync</span><span class="p">,</span><span class="w"> </span><span class="nx">milliSeconds</span><span class="o">:</span><span class="nx">number</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">   </span><span class="kd">const</span><span class="w"> </span><span class="nx">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="nx">resolve</span><span class="p">)=&gt;{</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">      </span><span class="nx">setTimeout</span><span class="p">(()=&gt;{</span><span class="w"> </span><span class="nx">resolve</span><span class="p">()</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">milliSeconds</span><span class="p">);</span><span class="w">  </span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="w">   </span><span class="p">});</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="nx">p</span><span class="p">;</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="p">}</span>
</span></code></pre></div>
<p>And has these import options set:
<div class="language-js highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="nx">imports</span><span class="o">:</span><span class="nx">TLibImports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="w">   </span><span class="nx">twr_sleep</span><span class="o">:</span><span class="p">{</span><span class="nx">isAsyncFunction</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">isModuleAsyncOnly</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">},</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="p">};</span>
</span></code></pre></div></p>
<p><code>isAsyncFunction: true</code> is telling twrLibrary to call the <code>twr_sleep_async</code> function with <code>await</code> and so allow the function being called to <code>await</code>. 
<code>isModuleAsyncOnly: true</code> is telling twrLibrary that this function only exists when <code>twrWasmModuleAsync</code> is used.</p>
<p>This code will execute in the JavaScript main thread.  The Calling C code (<code>twr_sleep</code>) will block in a Worker thread while waiting for this code in the JavaScrit main thread to complete.  The function <code>twr_sleep_async</code> creates a JavaScript promise that the calling code will <code>await</code> on.  Once the promise  resolves, the calling function will unblock the C <code>twr_sleep</code> function that is in the Worker Thread.</p>
<h2 id="import-options"><code>import</code> options</h2>
<p>The various <code>import</code> options are used to handle different cases for <code>twrWasmModuleAsync</code>.</p>
<p>The import options are:
<div class="language-text highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>isAsyncFunction?:boolean;
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>isModuleAsyncOnly?:boolean;
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>isCommonCode?:boolean;
</span></code></pre></div></p>
<h3 id="isasyncfunction"><code>isAsyncFunction</code></h3>
<p>This option is used when you wish to <code>await</code> inside the implementation of your function. This option also specifies that the function will be called with <code>await</code>.  </p>
<p>This option will only modify behavior this way when your function is called from <code>twrWasmModuleAsync</code>.</p>
<ul>
<li>If this option is not specified, the same <code>import</code> function will be used for both module types, and the function can not use the <code>await</code> keyword. </li>
<li>if this option is specified, then when <code>twrWasmModuleAsync</code> calls the indicated <code>import</code> function, it will call a version of the function that has <code>_async</code> append to the function name.  This means that you will create two versions of the <code>import</code> <code>funcA</code> - <code>funcA</code> and <code>funcA_async</code>. </li>
<li>If, however, you also specify the option <code>isModuleAsyncOnly</code>, then only the <code>_async</code> function is expected.</li>
</ul>
<p>Here is an example of how declare a function with the <code>import</code> option <code>isAsyncFunction</code>:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>async twr_sleep_async(callingMod:IWasmModuleAsync, milliSeconds:number)
</span></code></pre></div>
<p>Note that:</p>
<ul>
<li>the function declaration starts with the async keyword</li>
<li>the function has the suffix <code>_async</code> appended to its <code>import</code> name</li>
<li>that the function is passed an <code>IWasmModuleAsync</code> as the callingMod.</li>
</ul>
<p>By using this option, you may need to create two versions of the <code>import</code> function -- one that is <code>async</code> (for use by <code>twrWasmModuleAsync</code>), and one that does not use the <code>async</code> keyword--for use by <code>twrWasmModule</code>.</p>
<p>In a case like <code>twr_sleep</code>, there is only one function implemented for sleep - the async function.  But this is not always the case.  For example, if your <code>import</code> function uses the <code>wasmMem.PutXX</code> functions, you will need to create two functions for the <code>import</code>.  Here is an example:</p>
<div class="language-js highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="w"> </span><span class="nx">imports</span><span class="o">:</span><span class="nx">TLibImports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="w">      </span><span class="nx">ex_append_two_strings</span><span class="o">:</span><span class="p">{</span><span class="nx">isAsyncFunction</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">},</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="w">   </span><span class="p">};</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="w">   </span><span class="nx">ex_append_two_strings</span><span class="p">(</span><span class="nx">callingMod</span><span class="o">:</span><span class="nx">IWasmModule</span><span class="p">,</span><span class="w"> </span><span class="nx">str1Idx</span><span class="o">:</span><span class="nx">number</span><span class="p">,</span><span class="w"> </span><span class="nx">str2Idx</span><span class="o">:</span><span class="nx">number</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">newStr</span><span class="o">=</span><span class="nx">callingMod</span><span class="p">.</span><span class="nx">wasmMem</span><span class="p">.</span><span class="nx">getString</span><span class="p">(</span><span class="nx">str1Idx</span><span class="p">)</span><span class="o">+</span><span class="nx">callingMod</span><span class="p">.</span><span class="nx">wasmMem</span><span class="p">.</span><span class="nx">getString</span><span class="p">(</span><span class="nx">str2Idx</span><span class="p">);</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">rv</span><span class="o">=</span><span class="nx">callingMod</span><span class="p">.</span><span class="nx">wasmMem</span><span class="p">.</span><span class="nx">putString</span><span class="p">(</span><span class="nx">newStr</span><span class="p">);</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">rv</span><span class="p">;</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="w">   </span><span class="p">}</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="w">   </span><span class="k">async</span><span class="w"> </span><span class="nx">ex_append_two_strings_async</span><span class="p">(</span><span class="nx">callingMod</span><span class="o">:</span><span class="nx">IWasmModuleAsync</span><span class="p">,</span><span class="w"> </span><span class="nx">str1Idx</span><span class="o">:</span><span class="nx">number</span><span class="p">,</span><span class="w"> </span><span class="nx">str2Idx</span><span class="o">:</span><span class="nx">number</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">newStr</span><span class="o">=</span><span class="nx">callingMod</span><span class="p">.</span><span class="nx">wasmMem</span><span class="p">.</span><span class="nx">getString</span><span class="p">(</span><span class="nx">str1Idx</span><span class="p">)</span><span class="o">+</span><span class="nx">callingMod</span><span class="p">.</span><span class="nx">wasmMem</span><span class="p">.</span><span class="nx">getString</span><span class="p">(</span><span class="nx">str2Idx</span><span class="p">);</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a><span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">rv</span><span class="o">=</span><span class="k">await</span><span class="w"> </span><span class="nx">callingMod</span><span class="p">.</span><span class="nx">wasmMem</span><span class="p">.</span><span class="nx">putString</span><span class="p">(</span><span class="nx">newStr</span><span class="p">);</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">rv</span><span class="p">;</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a><span class="w">   </span><span class="p">}</span>
</span></code></pre></div>
<h3 id="ismoduleasynconly"><code>isModuleAsyncOnly</code></h3>
<p>This option specifies that the indicated function is only available to <code>twrWasmModuleAsync</code>. This option should be used for functions that block C execution. The <code>twr_sleep</code> is an example.</p>
<h3 id="iscommoncode"><code>isCommonCode</code></h3>
<p>This option is used to specify a function that should be used directly by the <code>twrWasmModuleAsync</code> Web Worker.  Without this option, the behavior is that code running in the Web Worker will send a message to the JavaScript Main thread requesting that the function be executed in the context of the JavaScript main thread.  The Web Worker will then wait for a reply to the message before continuing C execution.  However, in certain cases, it is possible, and might be more performant, to have the code execute directly in the WorkerThread.</p>
<p>There are limitations on the code that will work correctly with <code>isCommonCode</code>:</p>
<ul>
<li>The functions must be available to a Worker thread</li>
<li>The function can not be <code>async</code> (that is, it can not use <code>await</code>)</li>
<li>The function can not call <code>PostEvent</code></li>
<li>The functions must not depend on the Worker's main event loop running (this event loop often doesn't execute with the <code>twrWasmModuleAsync</code> Worker thread.)</li>
<li>The function can not use a callback (the callback won't get called because callbacks are often dispatched in the JavaScript main event loop)</li>
</ul>
<p>Here is an Example of using <code>isCommonCode</code>:</p>
<div class="language-js highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">twrLibMath</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">twrLibrary</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="w">   </span><span class="nx">imports</span><span class="o">:</span><span class="nx">TLibImports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="w">      </span><span class="nx">twrSin</span><span class="o">:</span><span class="p">{</span><span class="nx">isCommonCode</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">},</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="w">   </span><span class="p">}</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="w">   </span><span class="nx">libSourcePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="k">import</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">url</span><span class="p">).</span><span class="nx">pathname</span><span class="p">;</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="w">   </span><span class="nx">twrSin</span><span class="p">(</span><span class="nx">callingMod</span><span class="o">:</span><span class="nx">IWasmModule</span><span class="o">|</span><span class="nx">twrWasmBase</span><span class="p">,</span><span class="w"> </span><span class="nx">angle</span><span class="o">:</span><span class="nx">number</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="k">return</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">angle</span><span class="p">)}</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="p">}</span>
</span></code></pre></div>
<p>In this case the <code>Math.sin</code> function is available in both a Web Worker and the JavaScript main thread.  It is a simple function, that works fine without the JavaScript event loop operating.</p>
<h3 id="noblock">noBlock</h3>
<p><code>noBlock</code> will cause a function call in an <code>twrWasmModuleAsync</code> to send the message from the Worker proxy thread to the JS main thread to execute the function, but not to wait for the result.  This should only be used for functions with a <code>void</code> return value.  This has the advantage that (a) the C code will not block waiting for a void return value (so it returns faster), and (b) it takes advantage of multiple cores by allowing the JS Main thread and the Worker thread to execute in parallel.  </p>
<p>Note that the messages sent from the proxy thread to the JS main thread (for function execution) will cause execution of function calls to serialize, and so if a function that blocks (waits for results from JS main thread) is called after a call with <code>noBlock</code>, everything should work as expected.</p>
<p>Do not use <code>noBlock</code> if:</p>
<ul>
<li>the function returns a value</li>
<li>the C code should not continue executing until the function completes execution.</li>
<li>if the following scenario could arise:<ul>
<li>funcA (with noBlock) called</li>
<li>funcB called and returns a value or otherwise depends on funcA completing execution,  and funcA uses async keyword.</li>
</ul>
</li>
</ul>
<p>Use <code>noBlock</code> carefully.</p>
<h2 id="libsourcepath">libSourcePath</h2>
<p>Always set this as follows:
   <div class="language-js highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="nx">libSourcePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="k">import</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">url</span><span class="p">).</span><span class="nx">pathname</span><span class="p">;</span>
</span></code></pre></div></p>
<p><code>libSourcePath</code> is used to uniquely identify the library class, as well as to dynamically import the library when <code>isCommonCode</code> is used.</p>
<h2 id="interfacename">interfaceName</h2>
<p>In a twrLibrary, </p>
<ul>
<li>An "interface" refers to the set of functions that the library exposes to C. Ie, the functions in the <code>import</code> object.</li>
<li>The name of the interface is anonymous, unless <code>interfaceName</code> is set. </li>
<li>An undefined interfaceName (anonymous interface) also means that only one instance of that class is allowed (for example <code>twrLibMath</code>)</li>
<li>Set <code>interfaceName</code> to a unique name when multiple instances that support the same interface are allowed (for example the twr-wasm Consoles).  </li>
<li>Multiple classes may have the same interfaceName (a class is identified by its libSourcePath). For example <code>twrConDiv</code>, <code>twrConDebug</code>, <code>twrConTerminal</code> all have the same interface.</li>
</ul>
<p>When multiple instances of classes with the same interface are enabled (by setting <code>interfaceName</code>), the first argument in every C function call is expected to be the twrLibrary <code>id</code> (a member variable of the twrLibrary derived class).  The twrLibrary will use this <code>id</code> to route the function call to the correct instance of the library.  The <code>id</code> is not passed to the twrLibrary function (even though it is required to be the first C arg).</p>
<p>The twrLibrary instance should be created in the JavaScript main thread, and passed to the module in the <a href="../api-ts-modules/#io-option-multiple-consoles-with-names"><code>io</code> option.</a>  The C code can discover the <code>id</code>, by using the <a href="../api-c-con/#twr_get_console"><code>twr_get_console</code>.</a></p>
<div class="language-js highlight"><span class="filename">example</span><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="nx">interfaceName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;twrConsole&quot;</span><span class="p">;</span>
</span></code></pre></div>
<h2 id="the-twrwasmmoduleasync-event-loop">The <code>twrWasmModuleAsync</code> Event Loop</h2>
<p>TODO</p>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "content.code.copy"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.fe8b6f2b.min.js"></script>
      
    
  </body>
</html>